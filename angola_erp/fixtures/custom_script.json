[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Item", 
  "modified": "2017-08-30 11:49:28.131048", 
  "name": "Item-Client", 
  "script": "frappe.provide(\"erpnext.item\");\r\n\r\nfrappe.ui.form.on(\"Item\", {\r\n\trefresh: function(frm) {\r\n\t\tif (frm.doc.has_variants) {\r\n\t\t\tfrm.add_custom_button(__(\"Make New Item Code\"), function() {\r\n\t\t\t\terpnext.item.make_variant_custom()\r\n\t\t\t}, \"icon-list\", \"btn-default\");\r\n\t\t}\r\n\t},\r\n});\r\n\r\n$.extend(erpnext.item, {\r\n\tget_hidden_fields: function(){\r\n\t\tvar ret = {}, cur_attrs = [];\r\n\t\tcur_frm.doc.attributes.forEach(function(d){\r\n\t\t\tcur_attrs.push(d.attribute);\r\n\t\t});\r\n\t\tfrappe.call({\r\n\t\t\t'async': false,\r\n\t\t\t'method': 'frappe.client.get_list',\r\n\t\t\t'args': {\r\n\t\t\t\t'doctype': 'Item Attribute',\r\n\t\t\t\t'filters': [\r\n\t\t\t\t    ['Item Attribute', 'hidden', '=', 1],\r\n\t\t\t\t\t['Item Attribute', 'name', 'in', cur_attrs]\r\n\t\t\t\t],\r\n\t\t\t\tfields: [\r\n\t\t\t\t\t'name', 'update_from', 'source', 'relation'\r\n\t\t\t\t]\r\n\t\t\t},\r\n\t\t\t'callback': function(res){\r\n\t\t\t\t(res.message || []).forEach(function(r){\r\n\t\t\t\t\tvar only_allowed, options = [] ;\r\n\t\t\t\t\tif (!ret.hasOwnProperty(r.update_from)){\r\n\t\t\t\t\t\tret[r.update_from] = {};\r\n\t\t\t\t\t\tret[r.update_from]['source'] = r.source;\r\n\t\t\t\t\t\tret[r.update_from]['options'] = {}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tret[r.update_from][r.name] = r.relation;\r\n\t\t\t\t\tret[r.name] = r.update_from;\r\n\t\t\t\t\tonly_allowed = frappe.utils.filter_dict(cur_frm.doc.item_variant_restrictions, {\"attribute\": r.name});\r\n\t\t\t\t\t(only_allowed || []).forEach(function(d){\r\n\t\t\t\t\t\toptions.push(d.attribute)\r\n\t\t\t\t\t});\r\n\t\t\t\t\tif (!options.length){\r\n\t\t\t\t\t\tfrappe.call({\r\n\t\t\t\t\t\t\t'async': false,\r\n\t\t\t\t\t\t\t'method': 'frappe.client.get_list',\r\n\t\t\t\t\t\t\t'args': {\r\n\t\t\t\t\t\t\t\t'doctype': 'Item Attribute Value',\r\n\t\t\t\t\t\t\t\t'filters': [\r\n\t\t\t\t\t\t\t\t\t['Item Attribute Value', 'parent', '=', r.name]\r\n\t\t\t\t\t\t\t\t],\r\n\t\t\t\t\t\t\t\t'fields': ['attribute_value'],\r\n\t\t\t\t\t\t\t\t'limit_page_length': 500\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t'callback': function(res){\r\n\t\t\t\t\t\t\t\t(res.message || []).forEach(function(r){\r\n\t\t\t\t\t\t\t\t\toptions.push(r.attribute_value);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tret[r.update_from]['options'][r.name] = options;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn ret;\r\n\t},\r\n\tget_conversion_factors: function(from_uom, to_uom){\r\n\t\tvar ret;\r\n\t\tfrappe.call({\r\n\t\t\t'async': false,\r\n\t\t\t'method': 'rigpl_erpnext.rigpl_erpnext.item.get_uom_factors',\r\n\t\t\t'args':{\r\n\t\t\t\t'from_uom': from_uom,\r\n\t\t\t\t'to_uom': to_uom\r\n\t\t\t},\r\n\t\t\t'callback': function(res){\r\n\t\t\t\tret = res.message;\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn ret;\r\n\t},\r\n\tmake_variant_custom: function(doc) {\r\n\t\tvar fields = [], hidden_fields = this.get_hidden_fields(doc);\r\n\t\tfor(var i=0;i< cur_frm.doc.attributes.length;i++){\r\n\t\t\tvar row = cur_frm.doc.attributes[i],\r\n\t\t\t    field, creator;\r\n\t\t\tif (!hidden_fields.hasOwnProperty(row.attribute)){\r\n\t\t\t\tfield = {\r\n\t\t\t\t\t\"label\": (row.attribute + \" (\"+ row.field_name + \")\"),\r\n\t\t\t\t\t\"fieldname\": row.attribute,\r\n\t\t\t\t\t\"reqd\": 1,\r\n\t\t\t\t\t\"fieldtype\": row.numeric_values ? \"Float\": \"Select\",\r\n\t\t\t\t\t\"description\": row.numeric_values ?  \"Min Value: \"+ row.from_range +\" , Max Value: \"+ row.to_range +\", in Increments of: \"+ row.increment : \"\"\r\n\t\t\t\t}\r\n\t\t\t\tif (field.fieldtype==='Select') {\r\n\t\t\t\t\tvar filters = [\r\n\t\t\t\t\t\t\t['parent', '=', row.attribute],\r\n\t\t\t\t\t], allowed = [], options = [null];\r\n\t\t\t\t\tfrappe.utils.filter_dict(cur_frm.doc.item_variant_restrictions, {'attribute': row.attribute}).forEach(function(d){\r\n\t\t\t\t\t\tif (d.allowed_values) allowed.push(d.allowed_values);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tif (allowed.length){\r\n\t\t\t\t\t\toptions = options.concat(allowed);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tfrappe.call({\r\n\t\t\t\t\t\t\t'method': 'frappe.client.get_list',\r\n\t\t\t\t\t\t\t'async': false,\r\n\t\t\t\t\t\t\t'args': {\r\n\t\t\t\t\t\t\t\t'doctype': 'Item Attribute Value',\r\n\t\t\t\t\t\t\t\t'filters': filters,\r\n\t\t\t\t\t\t\t\t'fields': ['attribute_value']\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t'callback': function(res){\r\n\t\t\t\t\t\t\t\tres.message.forEach(function(d){\r\n\t\t\t\t\t\t\t\t\toptions.push(d.attribute_value);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfield.options = options;\r\n\t\t\t\t\tfields.push(field)\r\n\t\t\t\t}\r\n\t\t\t} else if (!hidden_fields[hidden_fields[row.attribute]].created){\r\n\t\t\t\tcreator = hidden_fields[row.attribute];\r\n\t\t\t\tfield = {\r\n\t\t\t\t\t'label': (creator + \" (\"+ row.field_name + \")\"),\r\n\t\t\t\t\t'fieldname': creator,\r\n\t\t\t\t\t'reqd': 1,\r\n\t\t\t\t\t'fieldtype': 'Data',\r\n\t\t\t\t};\r\n\t\t\t\thidden_fields[creator].created = true;\r\n\t\t\t\tfields.push(field)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar d = new frappe.ui.Dialog({\r\n\t\t\ttitle: __(\"Make Variant Custom\"),\r\n\t\t\tfields: fields\r\n\t\t});\r\n\t\t\r\n\t\tObject.keys(d.fields_dict).forEach(function(fieldname){\r\n\t\t\tif (d.fields_dict[fieldname].df.fieldtype!=='Data') return;\r\n\t\t\t\r\n\t\t\tvar field = d.fields_dict[fieldname],\r\n\t\t\t\ttarget = field.$input.parent(),\r\n\t\t\t    options = $('<ul class=\"dropdown-menu\"></ul>');\r\n\t\t\t\r\n\t\t\tObject.keys(hidden_fields[fieldname]).forEach(function(key){\r\n\t\t\t\tif (in_list(['created', 'source', 'options'], key)) return;\r\n\t\t\t\t\r\n\t\t\t\tvar option = $(format('<li><a data-option=\"{0}\">{0}</a></li>', [hidden_fields[fieldname][key]]));\r\n\t\t\t\toption.find('a').on('click', function(evt){\r\n\t\t\t\t\tevt.preventDefault();\r\n\t\t\t\t\tvar text = options.parent().find('button').text();\r\n\t\t\t\t\tif (text === $(this).text()) return;\r\n\t\t\t\t\toptions.parent().find('button').text($(this).text());\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (target.hasClass('ui-front')){\r\n\t\t\t\t\t\tfield.$input.autocomplete('destroy');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttarget.addClass('ui-front');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif ((hidden_fields[fieldname].options[key]||'').length){\r\n\t\t\t\t\t\tfield.$input.autocomplete({\r\n\t\t\t\t\t\t\tminChars: 0,\r\n\t\t\t\t\t\t\tminLength: 0,\r\n\t\t\t\t\t\t\tsource: hidden_fields[fieldname].options[key],\r\n\t\t\t\t\t\t\tselect: function(event, ui){\r\n\t\t\t\t\t\t\t\tfield.$input.val(ui.item.value);\r\n\t\t\t\t\t\t\t\tfield.$input.trigger('change');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\toptions.append(option);\r\n\t\t\t});\r\n\t\t\t\t\r\n\t\t\t$(format('<div class=\"input-group-btn\">\\\r\n\t\t\t\t <button type=\"button\" class=\"btn btn-default dropdown-toggle\" data-toggle=\"dropdown\" aria-haspopup=\"true\" data-fieldname=\"{1}\" aria-expanded=\"false\">{0}<span class=\"caret\"></span></button>\\\r\n\t\t\t  </div>', __([hidden_fields[fieldname].source, fieldname]))).append(options).prependTo(target);\r\n\t\t\t\r\n\t\t\ttarget.addClass('input-group');\r\n\t\t\t\r\n\t\t\tfield.$input.on('change', function(evt){\r\n\t\t\t\tif (!field.$input.val().length) return;\r\n\t\t\t\tvar uom = options.parent().find('button').text();\r\n\t\t\t\tif (uom===hidden_fields[fieldname].source){\r\n\t\t\t\t\tfield.$input.val(\"\");\r\n\t\t\t\t\tfrappe.throw(format('Select the \"{0}\" of the field \"{1}\"\", first!', [hidden_fields[fieldname].source, fieldname]))\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t\td.set_primary_action(__(\"Make\"), function() {\r\n\t\t\tvar rules = {},\r\n\t\t\targs = d.get_values();\r\n\t\t\tif(!args) return;\r\n\t\t\t\r\n\t\t\tfrappe.utils.filter_dict(cur_frm.doc.item_variant_restrictions, {'is_numeric': 1}).forEach(function(d){\r\n\t\t\t\tif (!rules.hasOwnProperty(d.attribute)) rules[d.attribute] = [];\r\n\t\t\t\trules[d.attribute].push(d.rule);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tObject.keys(args).filter(function(key){ return hidden_fields.hasOwnProperty(key); }).forEach(function(key){\r\n\t\t\t\tvar val = args[key], base, targets = Object.keys(hidden_fields[key]).filter(function(k){ return !in_list(['created', 'source', 'options'], k)});\r\n\t\t\t\ttry {\r\n\t\t\t\t\tbase = eval(val);\r\n\t\t\t\t} catch( e ){\r\n\t\t\t\t\tfrappe.throw(format('Failed to decode the value \"{0}\"', [val]));\r\n\t\t\t\t}\r\n\t\t\t\ttargets.forEach(function(tgt){\r\n\t\t\t\t\tvar uom = d.fields_dict[key].$input.parent().find('button').text(),\r\n\t\t\t\t\t\ttgt_uom = hidden_fields[key][tgt],\r\n\t\t\t\t\t    factors = erpnext.item.get_conversion_factors(uom, tgt_uom);\r\n\t\t\t\t\tif (uom === tgt_uom) {\r\n\t\t\t\t\t\targs[tgt] = val.indexOf('/') === -1 ? flt(val) : val;\r\n\t\t\t\t\t} else if (factors.rgt){\r\n\t\t\t\t\t\targs[tgt] = flt((base * factors.rgt).toFixed(frappe.defaults.get_global_default('float_precision')));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t    delete args[key];\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tconsole.table(Object.keys(args).map(function(k){ return {'key': k, 'value': args[k]}}));\r\n\t\t\t//debugger;\r\n\t\t\tObject.keys(args).forEach(function(attribute){\r\n\t\t\t\tif (!rules.hasOwnProperty(attribute)) return;\r\n\t\t\t\tvar msg = [];\r\n\t\t\t\tfor (var i=0, j=rules[attribute].length; i < j; i++){\r\n\t\t\t\t\twith (args){\r\n\t\t\t\t\t\tout = eval(rules[attribute][i]);\r\n\t\t\t\t\t\tif (!out){\r\n\t\t\t\t\t\t\tmsg.push(format('Unable for ensure the rule \"{1}\" for the field \"{0}\"', [attribute, rules[attribute][i]]));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (msg.length){\r\n\t\t\t\t\tfrappe.throw(msg.join('<br>'))\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tObject.keys(args).forEach(function(attribute){ args[attribute] = args[attribute] + '';});\r\n\t\t\tfrappe.call({\r\n\t\t\t\tmethod:\"erpnext.controllers.item_variant.get_variant\",\r\n\t\t\t\targs: {\r\n\t\t\t\t\t\"template\": cur_frm.doc.name,\r\n\t\t\t\t\t\"args\": args\r\n\t\t\t\t},\r\n\t\t\t\tcallback: function(r) {\r\n\t\t\t\t\t// returns variant item\r\n\t\t\t\t\tif (r.message) {\r\n\t\t\t\t\t\tvar variant = r.message;\r\n\t\t\t\t\t\tvar msgprint_dialog = frappe.msgprint(__(\"Item Variant {0} already exists with same attributes\",\r\n\t\t\t\t\t\t\t[repl('<a href=\"#Form/Item/%(item_encoded)s\" class=\"strong variant-click\">%(item)s</a>', {\r\n\t\t\t\t\t\t\t\titem_encoded: encodeURIComponent(variant),\r\n\t\t\t\t\t\t\t\titem: variant\r\n\t\t\t\t\t\t\t})]\r\n\t\t\t\t\t\t));\r\n\t\t\t\t\t\tmsgprint_dialog.hide_on_page_refresh = true;\r\n\t\t\t\t\t\tmsgprint_dialog.$wrapper.find(\".variant-click\").on(\"click\", function() {\r\n\t\t\t\t\t\t\td.hide();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\td.hide();\r\n\t\t\t\t\t\tfrappe.call({\r\n\t\t\t\t\t\t\tmethod:\"erpnext.controllers.item_variant.create_variant\",\r\n\t\t\t\t\t\t\targs: {\r\n\t\t\t\t\t\t\t\t\"item\": cur_frm.doc.name,\r\n\t\t\t\t\t\t\t\t\"args\": args\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tcallback: function(r) {\r\n\t\t\t\t\t\t\t\tvar doclist = frappe.model.sync(r.message);\r\n\t\t\t\t\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\td.show();\r\n\t},\r\n\ttoggle_attributes: function(frm) {\r\n\t\tfrm.toggle_display(\"attributes\", frm.doc.has_variants || frm.doc.variant_of);\r\n\t\tfrm.fields_dict.attributes.grid.toggle_reqd(\"attribute_value\", frm.doc.variant_of ? 1 : 0);\r\n\t\tfrm.fields_dict.attributes.grid.set_column_disp(\"attribute_value\", frm.doc.variant_of ? 1 : 0);\r\n\t}\r\n});\r\n\r\ncur_frm.cscript.custom_onload = function () {\r\n\tif (cur_frm.doc.has_variants == 1) {\r\n\t\tcur_frm.set_query('attribute', 'attributes', function(){\r\n\t\t\treturn {\r\n\t\t\t\tfilters: [\r\n\t\t\t\t\t['Item Attribute', 'virtual', '=', 0]\r\n\t\t\t\t]\r\n\t\t\t};\r\n\t\t});\r\n\t\tcur_frm.set_query('attribute', 'item_variant_restrictions', function(){\r\n\t\t\tvar attrs = []\r\n\t\t\tcur_frm.doc.attributes.forEach(function(row){\r\n\t\t\t\tattrs.push(row.attribute)\r\n\t\t\t});\r\n\t\t\treturn {'filters': [['Item Attribute', 'name', 'in', attrs]]}\r\n\t\t});\r\n\t\t\r\n\t}\r\n}\r\n//Below code would disable the attribute table after being saved.\r\nfrappe.ui.form.on(\"Item\", \"refresh\", function(frm){\r\n    frm.fields_dict.attributes.grid.df.read_only = frm.doc.__islocal ? false: true;\r\n\tfrm.fields_dict.attributes.grid.docfields.forEach(function(field){\r\n\t\tfield.read_only = frm.doc.__islocal ? false: true;\r\n\t});\r\n    frm.refresh_field(\"attributes\");\r\n});\r\n\r\nfrappe.ui.form.on(\"Item Variant Restrictions\", \"form_render\", function(frm, cdt, cdn){\r\n\tvar field = cur_frm.fields_dict.item_variant_restrictions.grid.grid_rows_by_docname[cdn].fields_dict.allowed_values;\r\n\t$(field.input_area).addClass('ui-front');\r\n\tfield.$input.autocomplete({\r\n\t\tminChars: 0,\r\n\t\tminLength: 0,\r\n\t\tsource: function(request, response){\r\n\t\t\tfrappe.call({\r\n\t\t\t\tmethod: 'frappe.client.get_list',\r\n\t\t\t\targs: {\r\n\t\t\t\t\tdoctype: 'Item Attribute Value',\r\n\t\t\t\t\tfilters: [\r\n\t\t\t\t\t\t['parent', '=', field.doc.attribute],\r\n\t\t\t\t\t\t['attribute_value', 'like', request.term + '%']\r\n\t\t\t\t\t],\r\n\t\t\t\t\tfields: ['attribute_value']\r\n\t\t\t\t},\r\n\t\t\t\tcallback: function(res){\r\n\t\t\t\t\tresponse($.map(res.message, function(d){ return d.attribute_value;}));\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t},\r\n\t\tselect: function(event, ui){\r\n\t\t\tfield.$input.val(ui.item.value);\r\n\t\t\tfield.$input.trigger('change');\r\n\t\t}\r\n\t});\r\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Purchase Invoice", 
  "modified": "2017-08-04 11:45:16.972963", 
  "name": "Purchase Invoice-Client", 
  "script": "\ntaxavenda= cur_frm.call({method:\"angola_erp.util.cambios.cambios\",args:{\"fonte\":\"BNA\"}})\nlista_retencoes = cur_frm.call({method:\"angola_erp.util.angola.get_lista_retencoes\",args:{}})\nlista_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_compras_taxa_retencao\",args:{}})\nlista_impostos = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_ipc\",args:{}})\n\nvar temretencao = false \nvar temimpostoconsumo = false \nvar retencaofonte =0\nvar retencaopercentagem =0\nvar totalpararetencao = 0\nvar totalgeralimpostoconsumo = 0\nvar totalgeralretencaofonte = 0\nvar totalbaseretencaofonte = 0\nvar retencaofonteDESC\nvar totalservicos_retencaofonte =0\nvar totaldespesas_noretencaofonte =0\nvar supplier_retencaofonte = 0\nvar fornecedor_retencao =0\n\nfrappe.ui.form.on(\"Purchase Invoice\", {\n\tonload:\tfunction(frm) {\n\t\tcur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t},\n\trefresh: function(frm) {\n\t\t//cur_frm.toggle_enable(\"contra_valor\",false)\n\t\tcur_frm.toggle_enable(\"total_retencao_na_fonte\",false)\n\t\tcur_frm.toggle_enable(\"base_retencao_fonte\",false)\n\t\tcur_frm.toggle_enable(\"taxa_cambio\",false)\n\t\tif (fornecedor_retencao !=0){\n\t\t\tfrappe.show_alert(fornecedor_retencao[0].retencao_na_fonte)\n\t\t\tfrappe.show_alert(fornecedor_retencao[0].que_retencao)\n\t\t}\n\t}\n});\n\nfrappe.ui.form.on(\"Purchase Invoice\",\"validate\", function (frm) {\n\t//alert (\"Validar\")\n\n\n\t\n\t//Taxa de Cambio\n\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\tcur_frm.doc.taxa_cambio_bna = taxavenda.responseJSON.message[1]\n\t}\t\t\n});\n\nfrappe.ui.form.on(\"Purchase Invoice\",\"cambio_bna\", function(frm,cdt,cdn) {\n\n\t\tfrappe.call({\n\t\t\tasync: true,\n\t\t\tmethod: \"angola_erp.util.cambios.cambios\",\n\t\t\targs: {\n\t\t\t\t\"fonte\":\"BNA\"\t\t\t\t\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\ttaxavenda = r.message\n\t\t\t\tcur_frm.doc.taxa_cambio = taxavenda[1]\n\t\t\t\trefresh_field(\"taxa_cambio\")\n\t\t\t}\n\t\t});\n\n\n\n});\n\n\nfrappe.ui.form.on(\"Purchase Invoice\",\"supplier\", function(doc,cdt,cdn) {\n\t\t//var supp = locals[cdt][cdn]\n\t\t//cur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t\t//cur_frm.toggle_enable(\"taxa_cambio\",false)\n\t\t//Taxa de Cambio\n\t\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\t\tcur_frm.doc.taxa_cambio = taxavenda.responseJSON.message[1]\n\t\t\tcur_frm.refresh_fields('taxa_cambio')\n\t\t}\t\n\t\t//Verifica se o supplier tem Retencao Fonte\t\n\t\tif (cur_frm.doc.supplier){\n\t\t\tfrappe.call({\n\t\t\t\tasync: false,\n\t\t\t\tmethod: \"angola_erp.util.angola.get_supplier_retencao\",\n\t\t\t\targs: {\n\t\t\t\t\t'fornecedor':cur_frm.doc.supplier\t\t\t\t\n\t\t\t\t},\n\t\t\t\tcallback: function(r,rt) {\n\t\t\t\t\tif (r.message){\n\t\t\t\t\t\tfornecedor_retencao = r.message\n\t\t\t\t\t\tconsole.log (fornecedor_retencao)\n\t\t\t\t\t}else{\t\n\t\t\t\t\t\tfrappe.show_alert('Este Fornecedor nao tem Retencao na Fonte')\n\t\t\t\t\t\tfornecedor_retencao=0\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\t\n\t\t\n\t\t\t\n\t\t\t//if (supp.retencao_na_fonte == 1){\n\t\t\t//\tsupplier_retencaofonte=1\n\t\t\t//}\n\t\t\n\t\t}\n\n});\n\t\ncur_frm.add_fetch('item_code','standard_rate','rate')\n//cur_frm.add_fetch('item_code','rate','standard_rate')\n\nfrappe.ui.form.on(\"Purchase Invoice Item\",\"item_code\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\t\n\ttotalpararetencao = d.amount\n\tif (lista_retencao.responseText.length ==2){\n\t\t\talert('Nao tem Retencao de Fonte criado nos Templates!!! ')\n\t\t\treturn\n\t}\n\tif (d.item_code){\n\t\tshow_alert(\"Total \" + d.amount,3)\t\n\t\tretencaofonte =0\n\t\tretencaopercentagem =0\n\t\tfrappe.model.with_doc(\"Item\", d.item_code, function() { \n\t\t\tvar dd = frappe.model.get_doc(\"Item\",d.item_code)\n\t\t\t//alert (\"rotina \", d.retencao_na_fonte)\n\t\t\tif (dd.retencao_na_fonte == 1){\n\t//\t\tif (d.que_retencao !=\"\"){\n\t\t\t\tfor (x = 0; x < lista_retencoes.responseJSON.message.length; x++){\n\t\t\t\t\tif (lista_retencoes.responseJSON.message[x].descricao == dd.que_retencao) {\n\t\t\t\t\t\tretencaopercentagem = lista_retencoes.responseJSON.message[x].percentagem\t\t\t\n\t\t\t\t\t\tretencaofonteDESC = dd.que_retencao\n\t\t\t\t\t}\t\t\t\n\t\t\t\t}\t\n\t\t\t\t//Retencao from Taxe and Charges list\n\t\t\t\tretencaofonteDESC = lista_retencao.responseJSON.message[0].parent \n\t\t\t\t\n\t\t\t}\n\t\t\t//First load qtd will always be 1 \n\t\t\tif (d.amount ==0){\n\t\t\t\td.retencao_na_fonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\n\t\t\t}else{\n\t\t\t\td.retencao_na_fonte = (d.amount * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (d.amount * retencaopercentagem) / 100\n\t\t\t}\n\t\t\t\n\t\t\tif (retencaofonte != 0) {\n\t\t\t\tshow_alert(\"Retencao na fonte\",3)\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//doc.set_value(\"taxes_and_charges\",retencaofonteDESC )\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\t\t\n\t\t\tif (dd.imposto_de_consumo == 1){\n\t\t\t\t//Busca o Imposto from Sales Taxes Charges (account 34210000)\t\t\t\n\t\t\t\tshow_alert(\"Imposto de Consumo\",3)\t\t\t\t\t\n\t\t\t\td.imposto_de_consumo = (d.amount * 10) / 100\n\t\t\t\ttotalgeralimpostoconsumo += d.imposto_de_consumo \n\t\t\t\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//Add Imposto e Consumo \n\t\t\t\t\t\n\t\t\t\t\tdoc.set_value(\"taxes_and_charges\", lista_impostos.responseJSON.message[0].parent )\n\t\t\t\t\tcur_frm.refresh_fields()\n\t\t\t\t\t//cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname[cdn].charge_type.refresh()\n\t\t\t\t\t// Now adds the Amount of the TAX based on the total of all itens \n\t\t\t\t\t//if(this.cur_frm.fields_dict[\"taxes\"].grid.get_field('charge_type')){\n\t\t\t\t\t//\talert(this.cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname['charge_type']) //get_field('charge_type'))\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\t\n\t\t\t\t\t//var tbl1 = cur_frm.doc.taxes || [];\n\t\t\t\t\t//alert (\"item code \" + tbl1.charge_type)\t\t\t\t\t\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,\"tax_amount\",totalgeralimpostoconsumo)  \n\t\t\t\t\t//} \t\t\n\t\t\t\t\t//cur_frm.cscript.validate_taxes_and_charges(\"Sales Taxes and Charges\", \"INVTD000005\" );\n\t\t\t\t\t\n//\t\t\t\t}else if (doc.fields_dict.taxes_and_charges.field[\"account_head\"] ==\"34210000\"){\n//\t\t\t\t\talert(\"AQUI Tem que ver\")\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\tvar me = this;\n\t\t\t\t\tvar tbl1 = this.cur_frm.doc[\"taxes\"];\n\t\t\t\t\t//alert(frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}))\n\t\t\t\t\t//frappe.model.set_value(frappe.utils.filter_dict(this.cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)  \n\t\t\t\t}\n\t\t\t\n\t\t\t}\t\n\t\n\n\t\t\t});\t\n\t}\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Program Enrollment", 
  "modified": "2017-07-19 17:32:23.039470", 
  "name": "Program Enrollment-Client", 
  "script": "escola_ginasio = cur_frm.call({method:\"angola_erp.util.angola.get_escola_ginasio\",args:{}})\n\n//Still a Test to see if fit to a Gymnasium\nfrappe.ui.form.on(\"Program Enrollment\", \"student\", function(frm) {\n\tshow_alert (escola_ginasio.responseJSON.message,2);\n\t//if (cur_frm.doc.ficha == 'Ginasio'){\n\tif (escola_ginasio.responseJSON.message == 'Ginasio'){\n\t\tcur_frm.toggle_enable(\"transportation\",false)\t\n\t\tcur_frm.set_df_property(\"transportation\",\"hidden\",true)\t\n\n\t}\n});\n\nfrappe.ui.form.on(\"Program Enrollment\", {\n    refresh: function(frm) {\n\tif (escola_ginasio.readyState != 1){\n\t\tshow_alert (escola_ginasio.responseJSON.message,2);\n\t}\n\tif (cur_frm.doc.ficha == 'Ginasio'){\n\t\tcur_frm.toggle_enable(\"transportation\",false)\t\n\t\tcur_frm.set_df_property(\"transportation\",\"hidden\",true)\t\n\n\t}\n    }\t\n});\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Student Applicant", 
  "modified": "2017-07-25 15:01:09.905559", 
  "name": "Student Applicant-Client", 
  "script": "escola_ginasio = cur_frm.call({method:\"angola_erp.util.angola.get_escola_ginasio\",args:{}})\nfrappe.ui.form.on(\"Student Applicant\", {\n\tonload:\tfunction(frm) {\n\t\tfrm.set_value(\"nationality\",'Angolana');\n\t}\n\n});\n\nfrappe.ui.form.on(\"Student Applicant\", {\n    refresh: function(frm) {\n\tif (escola_ginasio.readyState != 1){\n\t\tshow_alert (escola_ginasio.responseJSON.message,2);\n\t\tif (escola_ginasio.responseJSON.message == 'Ginasio'){\n\t\t\tcur_frm.toggle_enable(\"section_break_21\",false)\t\n\t\t\tcur_frm.set_df_property(\"section_break_21\",\"hidden\",true)\t\n\t\t\tcur_frm.toggle_enable(\"section_break_20\",false)\t\n\t\t\tcur_frm.set_df_property(\"section_break_20\",\"hidden\",true)\t\n\t\t\tcur_frm.set_df_property(\"siblings\",\"hidden\",true)\t\n\n\t\t}\n\t}\n\t}\n\n});\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Student", 
  "modified": "2017-07-25 14:58:29.437496", 
  "name": "Student-Client", 
  "script": "escola_ginasio = cur_frm.call({method:\"angola_erp.util.angola.get_escola_ginasio\",args:{}})\n\n//Still a Test to see if fit to a Gymnasium\nfrappe.ui.form.on(\"Student\", \"first_name\", function(frm) {\n\tshow_alert (escola_ginasio.responseJSON.message,2);\n\t//if (cur_frm.doc.ficha == 'Ginasio'){\n\tif (escola_ginasio.responseJSON.message == 'Ginasio'){\n\t\tcur_frm.toggle_enable(\"section_break_18\",false)\t\n\t\tcur_frm.set_df_property(\"section_break_18\",\"hidden\",true)\t\n\t\tcur_frm.toggle_enable(\"section_break_20\",false)\t\n\t\tcur_frm.set_df_property(\"section_break_20\",\"hidden\",true)\t\n\t\tcur_frm.set_df_property(\"siblings\",\"hidden\",true)\t\n\n\t}\n});\n\nfrappe.ui.form.on(\"Student\", {\n    refresh: function(frm) {\n\tif (escola_ginasio.readyState != 1){\n\t\tshow_alert (escola_ginasio.responseJSON.message,2);\n\t\tif (escola_ginasio.responseJSON.message == 'Ginasio'){\n\t\t\tcur_frm.toggle_enable(\"section_break_18\",false)\t\n\t\t\tcur_frm.set_df_property(\"section_break_18\",\"hidden\",true)\t\n\t\t\tcur_frm.toggle_enable(\"section_break_20\",false)\t\n\t\t\tcur_frm.set_df_property(\"section_break_20\",\"hidden\",true)\t\n\t\t\tcur_frm.set_df_property(\"siblings\",\"hidden\",true)\t\n\n\t\t}\n\t}\n\t}\n\n});\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Account", 
  "modified": "2016-12-01 17:17:27.206256", 
  "name": "Account-Client", 
  "script": "frappe.ui.form.on('Account', {\n\t\n\trefresh: function(frm) {\n\t\t//initially to see if Description show on the GRID ....\n\t},\n\n\tonrender: function(node) {\n\t\tvar dr_or_cr = node.data.balance < 0 ? \"Cr\" : \"Dr\";\n\t\tif (node.data && node.data.balance!==undefined) {\n\t\t\t\tif (node.data.descricao !==null) $('<span class=\"descricao-area pull-center text-muted small\">'\n\t\t\t\t+ \" - \" + node.data.descricao\n\t\t\t\t+ '</span>').insertBefore(node.$ul);\n\t\t\t$('<span class=\"balance-area pull-right text-muted small\">'\n\t\t\t\t+ (node.data.balance_in_account_currency ?\n\t\t\t\t\t(format_currency(Math.abs(node.data.balance_in_account_currency),\n\t\t\t\t\t\tnode.data.account_currency) + \" / \") : \"\")\n\t\t\t\t+ format_currency(Math.abs(node.data.balance), node.data.company_currency)\n\t\t\t\t+ \" \" + dr_or_cr\n\t\t\t\t+ '</span>').insertBefore(node.$ul);\t\t}\n\t},\n\n\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2017-02-24 14:45:58.712913", 
  "name": "Sales Invoice-Client", 
  "script": "taxavenda= cur_frm.call({method:\"angola_erp.util.cambios.cambios\",args:{\"fonte\":\"BNA\"}})\nlista_retencoes = cur_frm.call({method:\"angola_erp.util.angola.get_lista_retencoes\",args:{}})\nlista_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_retencao\",args:{}})\nlista_impostos = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_ipc\",args:{}})\n\nvar temretencao = false \nvar temimpostoconsumo = false \nvar retencaofonte =0\nvar retencaopercentagem =0\nvar totalpararetencao = 0\nvar totalgeralimpostoconsumo = 0\nvar totalgeralretencaofonte = 0\nvar totalbaseretencaofonte = 0\nvar retencaofonteDESC\nvar totalservicos_retencaofonte =0\nvar totaldespesas_noretencaofonte =0\n\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tonload:\tfunction(frm) {\n\t\tcur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t},\n\trefresh: function(frm) {\n\t\t//cur_frm.toggle_enable(\"contra_valor\",false)\n\t\tcur_frm.toggle_enable(\"total_retencao_na_fonte\",false)\n\t\tcur_frm.toggle_enable(\"taxa_cambio\",false)\n\t}\t\n\n});\n  \nfrappe.ui.form.on(\"Sales Invoice\",\"validate\", function (frm) {\n\t//alert (\"Validar\")\n\t//Taxa de Cambio\n\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\tcur_frm.doc.taxa_cambio_bna = taxavenda.responseJSON.message[1]\n\t}\t\t\n\t\t\n});\n\ncur_frm.cscript.custom_charge_type = function(doc,cdt,cd){\n\t\t\talert (\"custom Charge_type\")\n\t\t\tvar d = locals[cdt][cd]\t\n\t\t\tif (d.charge_type == 'On Net Total') {\t\t\t\n\t\t\t\tfrappe.model.set_value(cdt,cd,'rate', 6.5)\n\t\t\t\tfrappe.model.set_value(cdt,cd,'account_head','34130000-I Industrial - Retencao A Liquidar') \n\t\t\t\t\n\t\t\t}\n}\n\n\n\t\nfrappe.ui.form.on(\"Sales Invoice\",\"cambio_bna\", function(frm,cdt,cdn) {\n\tfrappe.call({\n\t\tasync: true,\n\t\tmethod: \"angola_erp.util.cambios.cambios\",\n\t\targs: {\n\t\t\t\"fonte\":\"BNA\"},\n\t\t\tcallback: function(r) {\n\t\t\t\ttaxavenda = r.message\n\t\t\t\tcur_frm.doc.taxa_cambio = taxavenda[1]\n\t\t\t\trefresh_field(\"taxa_cambio\")\n\t\t\t}\n\t\n\t});\n});\n\t\t\ncur_frm.cscript.custom_validate = function(doc, dt, dn) {\n\tif (doc.docstatus == 0){\n\t\tif (frappe.datetime.get_day_diff(new Date(), frappe.datetime.str_to_obj(doc.transaction_date)) > 0 && doc.order_type == \"Sales\") {\n\t\t\t//Due to normal clients this have to be removed for now....\n\t\t\t//validated = false;\n\t\t\t//msgprint(\"Data de Ordem de Venda nao pode ser anterior de hoje\"); // or any other message you want..\n\t\t}\n\t}\n}\nfrappe.ui.form.on(\"Sales Invoice\",\"customer\", function(doc,cdt,cdn) {\n\t\t//cur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t\t//cur_frm.toggle_enable(\"taxa_cambio\",false)\n\t\t//Taxa de Cambio\n\t\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\t\tcur_frm.doc.taxa_cambio = taxavenda.responseJSON.message[1]\n\t\t\tcur_frm.refresh_fields('taxa_cambio')\n\t\t}\t\t\n});\n\ncur_frm.add_fetch('item_code','standard_rate','rate')\n\nfrappe.ui.form.on(\"Sales Invoice Item\",\"item_code\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\t\n\ttotalpararetencao = d.amount\n\n\tif (d.item_code){\n\t\tshow_alert(\"Total \" + d.amount,3)\t\n\t\tretencaofonte =0\n\t\tretencaopercentagem =0\n\t\tfrappe.model.with_doc(\"Item\", d.item_code, function() { \n\t\t\tvar dd = frappe.model.get_doc(\"Item\",d.item_code)\n\t//\t\talert (\"rotina \", d.retencao_na_fonte)\n\t\t\tif (dd.retencao_na_fonte == 1){\n\t//\t\tif (d.que_retencao !=\"\"){\n\t\t\t\tfor (x = 0; x < lista_retencoes.responseJSON.message.length; x++){\n\t\t\t\t\tif (lista_retencoes.responseJSON.message[x].descricao == dd.que_retencao) {\n\t\t\t\t\t\tretencaopercentagem = lista_retencoes.responseJSON.message[x].percentagem\t\t\t\n\t\t\t\t\t\tretencaofonteDESC = dd.que_retencao\n\t\t\t\t\t}\t\t\t\n\t\t\t\t}\t\n\t\t\t\t//Retencao from Taxe and Charges list\n\t\t\t\tretencaofonteDESC = lista_retencao.responseJSON.message[0].parent \n\t\t\t\t\n\t\t\t}\n\t\t\t//First load qtd will always be 1 \n\t\t\tif (d.amount ==0){\n\t\t\t\td.retencao_na_fonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\n\t\t\t}else{\n\t\t\t\td.retencao_na_fonte = (d.amount * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (d.amount * retencaopercentagem) / 100\n\t\t\t}\n\t\t\t\n\t\t\tif (retencaofonte != 0) {\n\t\t\t\tshow_alert(\"Retencao na fonte\",3)\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//doc.set_value(\"taxes_and_charges\",retencaofonteDESC )\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\t\t\n\t\t\tif (dd.imposto_de_consumo == 1){\n\t\t\t\t//Busca o Imposto from Sales Taxes Charges (account 34210000)\t\t\t\n\t\t\t\tshow_alert(\"Imposto de Consumo\",3)\t\t\t\t\t\n\t\t\t\td.imposto_de_consumo = (d.amount * 10) / 100\n\t\t\t\ttotalgeralimpostoconsumo += d.imposto_de_consumo \n\t\t\t\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//Add Imposto e Consumo \n\t\t\t\t\t\n\t\t\t\t\tdoc.set_value(\"taxes_and_charges\", lista_impostos.responseJSON.message[0].parent )\n\t\t\t\t\tcur_frm.refresh_fields()\n\t\t\t\t\t//cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname[cdn].charge_type.refresh()\n\t\t\t\t\t// Now adds the Amount of the TAX based on the total of all itens \n\t\t\t\t\t//if(this.cur_frm.fields_dict[\"taxes\"].grid.get_field('charge_type')){\n\t\t\t\t\t//\talert(this.cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname['charge_type']) //get_field('charge_type'))\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\t\n\t\t\t\t\t//var tbl1 = cur_frm.doc.taxes || [];\n\t\t\t\t\t//alert (\"item code \" + tbl1.charge_type)\t\t\t\t\t\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,\"tax_amount\",totalgeralimpostoconsumo)  \n\t\t\t\t\t//} \t\t\n\t\t\t\t\t//cur_frm.cscript.validate_taxes_and_charges(\"Sales Taxes and Charges\", \"INVTD000005\" );\n\t\t\t\t\t\n//\t\t\t\t}else if (doc.fields_dict.taxes_and_charges.field[\"account_head\"] ==\"34210000\"){\n//\t\t\t\t\talert(\"AQUI Tem que ver\")\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\tvar me = this;\n\t\t\t\t\tvar tbl1 = this.cur_frm.doc[\"taxes\"];\n\t\t\t\t\t//alert(frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}))\n\t\t\t\t\t//frappe.model.set_value(frappe.utils.filter_dict(this.cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)  \n\t\t\t\t}\n\t\t\t\n\t\t\t}\t\n\t\n\n\t\t\t});\t\n\t}\n});\n\ncur_frm.cscript.amount = function(doc,cdt,cdn){\n//frappe.ui.form.on(\"Sales Invoice Item\",\"amount\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\talert(\"Total \" + d.amount)\n\t\n}\n//);\n\n\n\nfrappe.ui.form.on(\"taxes\",\"charge_type\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\talert(\"AQUII\")\n\t\n\t\n\t\n});\n\ncur_frm.cscript.tax_amount = function(doc,cdt,cdn) {\n\talert(\"tax Amount\")\n\t\n}\n\ncur_frm.cscript.charge_type = function(doc,cdt,cdn) {\n\talert(\"Charge\")\n\t\n}\n\n\n\nvar itens_ = function(frm,cdt,cdn){\n\tfrappe.model.with_doc(frm, cdt, function() { \n\t\tvar d = frappe.model.get_doc(frm,cdt)\n//\t\talert (\"rotina \", d.retencao_na_fonte)\n\t\tif (d.retencao_na_fonte == 1){\n\t\t\tretencaofonte = d.que_retencao\n\t\t\tshow_alert(\"tem retencao na fonte: \" + d.que_retencao,3)\t\n\n\t\t\t\n//\t\t\tfrappe.model.with_doc(\"Retencoes\", d.que_retencao, function() { \t\n//\t\t\t\tvar retencao = frappe.model.get_doc(\"Retencoes\", d.que_retencao)\n//\t\t\t\tretencaopercentagem = retencao.percentagem\n//\t\t\t\talert(\"Percentagem \" + totalpararetencao + \" \" + retencao.percentagem)\n//\t\t\t});\t\n\t\t\t\n\t\t}\n\n\t});\n}\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Purchase Order", 
  "modified": "2017-08-30 11:49:28.057078", 
  "name": "Purchase Order-Client", 
  "script": "cur_frm.cscript.is_subcontracting = function(doc, cdt, cdn) {\r\n\tcur_frm.set_query(\"item_code\", \"items\", function(){\r\n\t\tif (cur_frm.doc.is_subcontracting == 1){\r\n\t\t\treturn{\r\n\t\t\t\tquery: \"erpnext.controllers.queries.item_query\",\r\n\t\t\t\tfilters:{ 'is_sub_contracted_item': 1 }\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn{\r\n\t\t\t\tquery: \"erpnext.controllers.queries.item_query\",\r\n\t\t\t\tfilters:{'is_purchase_item':1}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n};\r\nfrappe.ui.form.on(\"Purchase Order\", \"refresh\", function(frm) {\r\n\r\n// Get Items from Production Order\r\n// Get Items from Production Order\r\ncur_frm.add_custom_button(__('Production Order'),\r\n    function() {\r\n    var me = this;\r\n    this.dialog = new frappe.ui.Dialog({\r\n        title: \"Get Items from Production Order\",\r\n        fields: [\r\n            {\"fieldtype\": \"Link\", \"label\": __(\"Production Order\"), \"fieldname\": \"production_order\",\"options\":'Production Order',\"reqd\": 1, \r\n                get_query: function() { return {query: \"rigpl_erpnext.rigpl_erpnext.validations.purchase_order.get_pending_prd\"}},\r\n            },\r\n            {\"fieldtype\": \"Button\", \"label\": __(\"Get\"), \"fieldname\": \"get\"},\r\n            {\"fieldtype\": \"HTML\", \"fieldname\": \"production_order_items_details\"},\r\n        ],\r\n    });\r\n    me.dialog.show();\r\n    fd = this.dialog.fields_dict;\r\n    this.dialog.fields_dict.get.$input.click(function() {\r\n        value = me.dialog.get_values();\r\n\r\n    frappe.call({    \r\n        method: \"frappe.client.get_list\",\r\n           args: {\r\n            doctype: \"Production Order\",\r\n               fields: [\"production_item\", \"item_description \", \"sales_order\", \"so_detail\", \"qty\",\"fg_warehouse\",\"stock_uom\",\"name\"],\r\n               filters: { \"name\" : value.production_order\r\n                },\r\n            },\r\n            callback: function(res){\r\n            if(res && res.message){\r\n                    var row = frappe.model.add_child(cur_frm.doc, \"Purchase Order Item\", \"items\");\r\n                    row.qty = res.message[0]['qty'];\r\n\t\t\t\t\tif (cur_frm.doc.is_subcontracting == 1){\r\n\t\t\t\t\t\trow.subcontracted_item = res.message[0]['production_item'];\r\n\t\t\t\t\t} else{\r\n\t\t\t\t\t\trow.item_code = res.message[0]['production_item'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\trow.description = res.message[0]['item_description'];\r\n                    row.so_detail = res.message[0]['so_detail'];\r\n                    row.uom = res.message[0]['stock_uom'];\r\n                    row.stock_uom = res.message[0]['stock_uom'];\r\n                    row.conversion_factor = 1;\r\n                refresh_field(\"items\");\r\n            }\r\n        }\r\n    });\r\n\r\n\r\n    });\r\n\r\n    add_production_order_items_to_stock = function(){\r\n        var items_to_add = []\r\n        value = me.dialog.get_values();\r\n        $.each($(fd.production_order_items_details.wrapper).find(\".select:checked\"), function(name, item){\r\n            items_to_add.push($(item).val());\r\n        });\r\n        if(items_to_add.length > 0){\r\n            for(i=0;i<items_to_add.length;i++){\r\n                add_production_order_items(items_to_add,i)\r\n            }\r\n            me.dialog.hide()\r\n        }    \r\n        else{\r\n            msgprint(\"Select Item Before Add\")\r\n        }\r\n    }\r\n}, __(\"Add items from\"));\r\n\r\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Customer", 
  "modified": "2017-08-30 11:49:28.114506", 
  "name": "Customer-Client", 
  "script": "cur_frm.add_fetch('charge','letter_head','letter_head');\r\nfrappe.ui.form.on(\"Customer\", \"refresh\", function(frm) {\r\n    frm.add_custom_button(__(\"Sales Call\"), function() {\r\n        // When this button is clicked, do this\r\n\t\t\tfrappe.set_route(\"Form\", \"Sales Call Tool\",\r\n\t\t\t{\"document\": \"Customer\",\r\n\t\t\t \"customer\": frm.doc.name,\r\n\t\t\t \"date_of_communication\": Date()});\r\n\r\n    },  __(\"Add Communication for\"));\r\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Order", 
  "modified": "2017-02-24 00:15:18.019895", 
  "name": "Sales Order-Client", 
  "script": "\ntaxavenda= cur_frm.call({method:\"angola_erp.util.cambios.cambios\",args:{\"fonte\":\"BNA\"}})\nlista_retencoes = cur_frm.call({method:\"angola_erp.util.angola.get_lista_retencoes\",args:{}})\nlista_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_retencao\",args:{}})\nlista_impostos = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_ipc\",args:{}})\n\nvar temretencao = false \nvar temimpostoconsumo = false \nvar retencaofonte =0\nvar retencaopercentagem =0\nvar totalpararetencao = 0\nvar totalgeralimpostoconsumo = 0\nvar totalgeralretencaofonte = 0\nvar totalbaseretencaofonte = 0\nvar retencaofonteDESC\nvar totalservicos_retencaofonte =0\nvar totaldespesas_noretencaofonte =0\n\n\nfrappe.ui.form.on(\"Sales Order\", {\n\tonload:\tfunction(frm) {\n\t\tcur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t},\n\trefresh: function(frm) {\n\t\t//cur_frm.toggle_enable(\"contra_valor\",false)\n\t\tcur_frm.toggle_enable(\"total_retencao_na_fonte\",false)\n\t\tcur_frm.toggle_enable(\"taxa_cambio\",false)\n\t}\n});\n\nfrappe.ui.form.on(\"Sales Order\",\"validate\", function (frm) {\n\t//alert (\"Validar\")\n\n\n\t\n\t//Taxa de Cambio\n\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\tcur_frm.doc.taxa_cambio_bna = taxavenda.responseJSON.message[1]\n\t}\t\t\n});\n\nfrappe.ui.form.on(\"Sales Order\",\"cambio_bna\", function(frm,cdt,cdn) {\n\n\t\tfrappe.call({\n\t\t\tasync: true,\n\t\t\tmethod: \"angola_erp.util.cambios.cambios\",\n\t\t\targs: {\n\t\t\t\t\"fonte\":\"BNA\"\t\t\t\t\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\ttaxavenda = r.message\n\t\t\t\tcur_frm.doc.taxa_cambio = taxavenda[1]\n\t\t\t\trefresh_field(\"taxa_cambio\")\n\t\t\t}\n\t\t});\n\n\n\n});\n\n\ncur_frm.cscript.custom_validate = function(doc, dt, dn) {\n\n    if (doc.docstatus == 0){\n\n\t\tif (frappe.datetime.get_day_diff(new Date(), frappe.datetime.str_to_obj(doc.transaction_date)) > 0 && doc.order_type == \"Sales\") {\n\t\t\t//Due to normal clients this have to be removed for now....\n\t\t\t//validated = false;\n\n\t\t\t//msgprint(\"Data de Ordem de Venda nao pode ser anterior de hoje\"); // or any other message you want..\n\n\t\t}\n\n\t}\t\n\n};\n\nfrappe.ui.form.on(\"Sales Order\",\"customer\", function(doc,cdt,cdn) {\n\t\t//cur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t\t//cur_frm.toggle_enable(\"taxa_cambio\",false)\n\t\t//Taxa de Cambio\n\t\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\t\tcur_frm.doc.taxa_cambio = taxavenda.responseJSON.message[1]\n\t\t\tcur_frm.refresh_fields('taxa_cambio')\n\t\t}\t\t\n});\n\t\ncur_frm.add_fetch('item_code','standard_rate','rate')\n//cur_frm.add_fetch('item_code','rate','standard_rate')\n\nfrappe.ui.form.on(\"Sales Order Item\",\"item_code\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\t\n\ttotalpararetencao = d.amount\n\n\tif (d.item_code){\n\t\tshow_alert(\"Total \" + d.amount,3)\t\n\t\tretencaofonte =0\n\t\tretencaopercentagem =0\n\t\tfrappe.model.with_doc(\"Item\", d.item_code, function() { \n\t\t\tvar dd = frappe.model.get_doc(\"Item\",d.item_code)\n\t//\t\talert (\"rotina \", d.retencao_na_fonte)\n\t\t\tif (dd.retencao_na_fonte == 1){\n\t//\t\tif (d.que_retencao !=\"\"){\n\t\t\t\tfor (x = 0; x < lista_retencoes.responseJSON.message.length; x++){\n\t\t\t\t\tif (lista_retencoes.responseJSON.message[x].descricao == dd.que_retencao) {\n\t\t\t\t\t\tretencaopercentagem = lista_retencoes.responseJSON.message[x].percentagem\t\t\t\n\t\t\t\t\t\tretencaofonteDESC = dd.que_retencao\n\t\t\t\t\t}\t\t\t\n\t\t\t\t}\t\n\t\t\t\t//Retencao from Taxe and Charges list\n\t\t\t\tretencaofonteDESC = lista_retencao.responseJSON.message[0].parent \n\t\t\t\t\n\t\t\t}\n\t\t\t//First load qtd will always be 1 \n\t\t\tif (d.amount ==0){\n\t\t\t\td.retencao_na_fonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\n\t\t\t}else{\n\t\t\t\td.retencao_na_fonte = (d.amount * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (d.amount * retencaopercentagem) / 100\n\t\t\t}\n\t\t\t\n\t\t\tif (retencaofonte != 0) {\n\t\t\t\tshow_alert(\"Retencao na fonte\",3)\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//doc.set_value(\"taxes_and_charges\",retencaofonteDESC )\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\t\t\n\t\t\tif (dd.imposto_de_consumo == 1){\n\t\t\t\t//Busca o Imposto from Sales Taxes Charges (account 34210000)\t\t\t\n\t\t\t\tshow_alert(\"Imposto de Consumo\",3)\t\t\t\t\t\n\t\t\t\td.imposto_de_consumo = (d.amount * 10) / 100\n\t\t\t\ttotalgeralimpostoconsumo += d.imposto_de_consumo \n\t\t\t\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//Add Imposto e Consumo \n\t\t\t\t\t\n\t\t\t\t\tdoc.set_value(\"taxes_and_charges\", lista_impostos.responseJSON.message[0].parent )\n\t\t\t\t\tcur_frm.refresh_fields()\n\t\t\t\t\t//cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname[cdn].charge_type.refresh()\n\t\t\t\t\t// Now adds the Amount of the TAX based on the total of all itens \n\t\t\t\t\t//if(this.cur_frm.fields_dict[\"taxes\"].grid.get_field('charge_type')){\n\t\t\t\t\t//\talert(this.cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname['charge_type']) //get_field('charge_type'))\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\t\n\t\t\t\t\t//var tbl1 = cur_frm.doc.taxes || [];\n\t\t\t\t\t//alert (\"item code \" + tbl1.charge_type)\t\t\t\t\t\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,\"tax_amount\",totalgeralimpostoconsumo)  \n\t\t\t\t\t//} \t\t\n\t\t\t\t\t//cur_frm.cscript.validate_taxes_and_charges(\"Sales Taxes and Charges\", \"INVTD000005\" );\n\t\t\t\t\t\n//\t\t\t\t}else if (doc.fields_dict.taxes_and_charges.field[\"account_head\"] ==\"34210000\"){\n//\t\t\t\t\talert(\"AQUI Tem que ver\")\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\tvar me = this;\n\t\t\t\t\tvar tbl1 = this.cur_frm.doc[\"taxes\"];\n\t\t\t\t\t//alert(frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}))\n\t\t\t\t\t//frappe.model.set_value(frappe.utils.filter_dict(this.cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)  \n\t\t\t\t}\n\t\t\t\n\t\t\t}\t\n\t\n\n\t\t\t});\t\n\t}\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Lead", 
  "modified": "2017-08-30 11:49:28.122473", 
  "name": "Lead-Client", 
  "script": "frappe.ui.form.on(\"Lead\", \"refresh\", function(frm) {\r\n    frm.add_custom_button(__(\"Sales Call\"), function() {\r\n        // When this button is clicked, do this\r\n\t\t\tfrappe.set_route(\"Form\", \"Sales Call Tool\",\r\n\t\t\t{\"document\": \"Lead\",\r\n\t\t\t \"lead\": frm.doc.name,\r\n\t\t\t \"date_of_communication\": Date()});\r\n\t\t\t \r\n    },  __(\"Add Communication for\"));\r\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Communication", 
  "modified": "2017-08-30 11:49:28.139508", 
  "name": "Communication-Client", 
  "script": "$.extend(frappe.views.CommunicationComposer, {\r\n\t\r\n});", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Salary Slip", 
  "modified": "2017-06-15 16:37:51.688671", 
  "name": "Salary Slip-Client", 
  "script": "// Copyright (c) 2016, HELKyds lda. and contributors\n// For license information, please see license.txt\n//IRT_INSS v2\n\n\nvar irt=0;\nvar inss=0;\nvar salario = 0;\nvar numero_faltas =0;\nvar valor_inicio =0;\nvar valor_fim = 0;\nvar valor_percentual = 0;\nvar parcela_fixa = 0;\n\nlista_irt = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_lista_irt\",args:{}})\ncontador = 0\n\n\nfrappe.ui.form.on('Salary Slip', {\n\n\trefresh: function(frm) {\n\n\t\t//Get Salario\n\t\t//cur_frm.toggle_enable(\"salario_iliquido\",false)\t\t\n\t\t\n\t\tconsole.log (\"Salary Slip REFRESH \", contador )\n\t\tcontador += 1\n\t\tvar tbl1 = frm.doc.earnings || [];\n\n//\t\tvar tbl2 = frm.doc.deductions || [];\n\n\t\tinss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_inss\",args:{}})\t\n\n\t\tif (frm.doc.employee != undefined){\n\t\t\tif (numero_faltas.readyState == 4){\n\t\t\t\tif (oldemp != frm.doc.employee || oldmonth != moment(frm.doc.start_date).month()+1 || oldyear != moment(frm.doc.start_date).year()){\n\t\t\t\t\tnumero_faltas = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_faltas\",args:{\"emp\":frm.doc.employee,\"mes\":moment(frm.doc.start_date).month()+1, \"ano\":moment(frm.doc.start_date).year(),\"empresa\":frm.doc.company}}) \n\t\t\t\t\toldemp = frm.doc.employee\n\t\t\t\t\toldmonth = moment(frm.doc.start_date).month()+1\n\t\t\t\t\toldyear = moment(frm.doc.start_date).year()\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\tcur_frm.doc.numero_de_faltas = numero_faltas.responseJSON.message[0]\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tnumero_faltas = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_faltas\",args:{\"emp\":frm.doc.employee, \"mes\":moment(frm.doc.start_date).month()+1, \"ano\":moment(frm.doc.start_date).year(), \"empresa\":frm.doc.company}}) \n\t\t\t\toldemp = frm.doc.employee\n\t\t\t\toldmonth = moment(frm.doc.start_date).month()+1\n\t\t\t\toldyear = moment(frm.doc.start_date).year()\n\t\t\t\t\n\t\t\t}\n\t\t\tconsole.log (\"Salary Slip FALTAS\")\n\t\t}else if (numero_faltas !=0){\n\t\t\tif (numero_faltas.readyState != 1){\n\t\t\t\tcur_frm.doc.numero_de_faltas = numero_faltas.responseJSON.message[0]\n\t\t\t}\n\t\t\tconsole.log (\"Salary Slip FALTAS 1\")\n\t\t}\n\t\t\n\t\tfor(var i = 0; i < tbl1.length; i++){\n\n\t\t\tif (tbl1[i].salary_component == \"Salario Base\" || tbl1[i].salary_component == \"Basic\" && tbl1[i].amount != 0){\n\n\t\t\t\tif (cur_frm.doc.salario_iliquido == 0 ){\n\t\t\t\t\tsalario = tbl1[i].amount;\t\n\t\t\t\t}else{\n\t\t\t\t\tsalario = cur_frm.doc.salario_iliquido;\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (lista_irt.readyState !=1){\n\t\t\t\t\tfor (var x =0; x < lista_irt.responseJSON.message.length; x++){\n\t\t\t\t\t\t//valor_inicio <= %(start)s and valor_fim >=%(start)s\n\t\t\t\t\t\tif (lista_irt.responseJSON.message[x].valor_inicio <= salario && lista_irt.responseJSON.message[x].valor_fim >= salario){\n\t\t\t\t\t\t\tvalor_inicio = lista_irt.responseJSON.message[x].valor_inicio\n\t\t\t\t\t\t\tvalor_fim = lista_irt.responseJSON.message[x].valor_fim\n\t\t\t\t\t\t\tvalor_percentual = lista_irt.responseJSON.message[x].valor_percentual\n\t\t\t\t\t\t\tparcela_fixa = lista_irt.responseJSON.message[x].parcela_fixa\t\n\t\t\t\t\t\t\tx = lista_irt.responseJSON.message.length +1 \n\t\n\t\t\t\t\t\t}else if (lista_irt.responseJSON.message[x].valor_fim >= salario){\n\t\t\t\t\t\t\tvalor_inicio = lista_irt.responseJSON.message[x].valor_inicio\n\t\t\t\t\t\t\tvalor_fim = lista_irt.responseJSON.message[x].valor_fim\n\t\t\t\t\t\t\tvalor_percentual = lista_irt.responseJSON.message[x].valor_percentual\n\t\t\t\t\t\t\tparcela_fixa = lista_irt.responseJSON.message[x].parcela_fixa\t\n\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tconsole.log (\"NAO PROCESSA AQUI !!!!\")\n//\t\t\t\t\tirt_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_irt\",args:{\"start\":salario}})\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\t\n\t\tif (numero_faltas.responseJSON != undefined){\n\t\t\tshow_alert(\"Numero de Faltas \" + numero_faltas.responseJSON.message[0])\n\t\t\tshow_alert(numero_faltas.valueOf.length)\n\t\t}\n\t\t\n\t\tif(!frm.doc.__islocal) {\n\n\t\t\tcur_frm.add_custom_button(__('Calcular IRT & INSS'),cur_frm.cscript['calcular_irt_inss'], \"icon-list\", \"btn-default\");\n\n\n\t\t}\n\n\n\t},\n\n\t\n\n\t\n\n});\n\n\n\n\ncur_frm.cscript.calcular_irt_inss = function(doc,cdt,cdn){\n\n\n//\t\t\tcur_frm.add_custom_button(__('Calcular IRT & INSS'),function(doc, cdt, cdn) {\n\n\tvar tbl1 = cur_frm.doc.earnings || [];\n\tvar tbl2 = cur_frm.doc.deductions || [];\n\n\tfor(var i = 0; i < tbl1.length; i++){\n\n\t\tif (tbl1[i].salary_component == \"Salario Base\" || tbl1[i].salary_component == \"Basic\" && tbl1[i].amount != 0){\n\n\t\t\tif (valor_fim !=0){\n\t\t\t\tirt = flt(salario) - valor_inicio;\n\n\t\t\t\tirt = (irt * valor_percentual/ 100) + parcela_fixa;\n\t\t\t\n\t\t\t}else if (irt_valor.responseJSON.message[0].valor_inicio !=undefined){\n\n\t\t\t\tirt = flt(salario) - irt_valor.responseJSON.message[0].valor_inicio;\n\n\t\t\t\tirt = (irt * irt_valor.responseJSON.message[0].valor_percentual/ 100) + irt_valor.responseJSON.message[0].parcela_fixa;\n\n\t\t\t}else{\n\n\t\t\t\tirt = flt(salario) - irt_valor.responseJSON.message[0][0];\n\n\t\t\t\tirt = (irt * irt_valor.responseJSON.message[0][2]/ 100) + irt_valor.responseJSON.message[0][3];\t\t\t\t\t\t\t\n\n\t\t\t}\t\t\t\t\t\t\t\n\n\t\t}\t\t\t\t\t\n\n\t}\n\n\ttotaldeducoes = 0\n\tfor(var j = 0; j < tbl2.length; j++){\n\n\t\tif (tbl2[j].salary_component == \"IRT\" ){\n\n\t\t\tirt_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":irt}});\n\n\t\t}else if (tbl2[j].salary_component == \"INSS\" ){\t\n\n\t\t\tif (inss_valor.responseJSON.message !=undefined){\n\n\t\t\t\t//inss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_inss\",args:{}})\t\n\n\t\t\t\tinss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":flt(salario)*inss_valor.responseJSON.message}});\n\n\t\t\t}else{\n\n\t\t\t\talert(\"INSS\")\n\n\t\t\t}\n\t\t}else if (tbl2[j].salary_component == \"Faltas Injustificadas\" ){\t\n\t\t\t//so pode ser feito no SALARY SLIP due to the Month being processed.\n\t\t\t//alert(total_days_in_month - numero_faltas.responseJSON.message[0])\n\t\t\t\t//desconto_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":(flt(salario)/26)*numero_faltas.responseJSON.message[0]}});\n\n\t\t\t//OUTRA Formula para desconto de Faltas SB/26/2+SB/26*numero_faltas\n\t\t\tdesconto_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":(((flt(salario)/26)/2)+(flt(salario)/26))*numero_faltas.responseJSON.message[0]}});\n\n\t\t\t//if leave without pay 0 than payment days less numero_faltas otherwise working days - leave without - numero_faltas\n\t\t\tif (cur_frm.doc.leave_without_pay ==0){\n\t\t\t\tpagamentodias = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_salary_slip_pay_days\",args:{\"emp\":cur_frm.doc.employee, \"mes\":moment(frm.doc.start_date).month()+1, \"ano\":moment(frm.doc.start_date).year(), \"pag\":(cur_frm.doc.total_days_in_month - numero_faltas.responseJSON.message[0]) }});\n\t\t\t\tfrappe.model.set_value(cur_frm.doc.doctype,cur_frm.doc.name,'payment_days',cur_frm.doc.total_days_in_month  - numero_faltas.responseJSON.message[0]) \n\t\t\t}else{\n\t\t\t\tpagamentodias = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_salary_slip_pay_days\",args:{\"emp\":cur_frm.doc.employee, \"mes\":moment(frm.doc.start_date).month()+1, \"ano\":moment(frm.doc.start_date).year(), \"pag\":(cur_frm.doc.total_days_in_month - cur_frm.doc.leave_without_pay - numero_faltas.responseJSON.message[0]) }});\n\n\t\t\t}\n\n\n\n\t\t}\t\n\t\ttotaldeducoes += tbl2[j].amount\n\n\t}\n\t\n\t//calculate_earning_total(cur_frm.doc, cur_frm.doc.doctype, cur_frm.doc.name,true);\n\n\t//calculate_ded_total(cur_frm.doc, cur_frm.doc.doctype, cur_frm.doc.name,true);\n//\t\t\t\tcur_frm.doc.total_deduction = totaldeducoes\n\tfrappe.model.set_value(cur_frm.doc.doctype,cur_frm.doc.name,'total_deduction',totaldeducoes)\n\trefresh_field('gross_pay','total_deduction');\n\tcalculate_net_pay(cur_frm.doc, cur_frm.doc.doctype, cur_frm.doc.name);\n\n\n//\t\t\t\tcur_frm.refresh()\n\n//\t\t\t\tcur_frm.reload_doc()\n\n\n//\t\t\t});\n}\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Process Payroll", 
  "modified": "2017-06-21 22:34:22.059492", 
  "name": "Process Payroll-Client", 
  "script": "\n\nfrappe.ui.form.on(\"Process Payroll\", {\n\tonload:\tfunction(frm) {\n\t\tcur_frm.toggle_enable(\"processar_faltas\",false)\t\t\n\t\tcur_frm.toggle_enable(\"processa_inss\",false)\t\t\n\t\tcur_frm.toggle_enable(\"processa_salario\",false)\t\t\n\t\t//cur_frm.toggle_enable(\"salary_review\",false)\n\t\t//cur_frm.toggle_enable(\"submit_salary_slip\",false)\n\n\t}\n\n});\n\ncur_frm.cscript.processa_salario = function(doc,cdt,cdn){\n\t\tshow_alert(\"Ja processou o Salario\",2)\n\t\tif (cur_frm.ss_html){\n\t\t\tconsole.log(cur_frm.ss_html.innerHTML);\n\t\t\tfor (xx in cur_frm.ss_html.getElementsByTagName('caption')){\n\t\t\t\tjv = cur_frm.ss_html.getElementsByTagName('caption')[xx].innerText \n\t\t\t\tif (jv != undefined){\n\t\t\t\t\tif (jv.search(\"Created Salary Slips\") != -1 ){\n\t\t\t\t\t\t//alert(\"VAMOS fazer o Sal Iliquido\")\n\t\t\t\t\t\tsaliliquido = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.salary_slip.proc_salario_iliquido\",args:{\"mes\":moment(cur_frm.doc.start_date).month()+1, \"ano\":moment(cur_frm.doc.start_date).year(), \"empresa\":cur_frm.doc.company}}) \n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcur_frm.toggle_enable(\"salary_review\",true)\n\t\tshow_alert(\"Antes de Submeter o Sal\u00e1rio fa\u00e7a uma Revis\u00e3o/Aprova\u00e7\u00e3o.\")\n\t\tcur_frm.toggle_enable(\"submit_salary_slip\",true)\n\t\t\n\t\n}\t\ncur_frm.cscript.processa_inss = function(doc,cdt,cdn){\n\t//show_alert(\"Vou processar \");\n\tif (cur_frm.ss_html){\n\t\tconsole.log(cur_frm.ss_html.innerHTML);\n\t\tfor (xx in cur_frm.ss_html.getElementsByTagName('a')){\n\t\t\tjv = cur_frm.ss_html.getElementsByTagName('a')[xx].innerText \n\t\t\tif (jv != undefined){\n\t\t\t\tif (jv.search(\"JV-\") != -1 ){\n\t\t\t\t\tshow_alert (\"JV CRIADA \" + \tcur_frm.ss_html.getElementsByTagName('a')[xx].innerText,2);\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t//alert(cur_frm.ss_html.getElementById(\"a href\").innerHTML);\n\t}\n}\n\ncur_frm.cscript.processar_faltas = function(doc,cdt,cdn){\n\n\n\tcur_frm.cscript.display_activity_log(\"Processando Faltas... Aguarde.\");\n\tnumero_faltas = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_faltas\",args:{\"mes\":moment(cur_frm.doc.start_date).month()+1, \"ano\":moment(cur_frm.doc.start_date).year(), \"empresa\":cur_frm.doc.company}}) \n\tcur_frm.cscript.display_activity_log(\"Processamento Feito.\");\n\n}\t\n\ncur_frm.cscript.create_salary_slip = function(doc, cdt, cdn) {\n\t//alert(\"BOTAO\")\n\t//REMOVE Botao Processar Faltas ....\n\tcur_frm.cscript.processar_faltas();\n\tcur_frm.cscript.display_activity_log(\"Processando Salarios... Aguarde.\");\n\n\n\tvar callback = function(r, rt){\n\t\tif (r.message)\n\t\t\tcur_frm.cscript.display_activity_log(r.message);\n\t\t\tfrappe.model.set_value(cdt,cdn,'processa_salario',1);  \n\n\t\t\n\t}\n\n\treturn $c('runserverobj', args={'method':'create_salary_slips','docs':doc},callback);\n\t\n\n}\n\n\n\ncur_frm.cscript.submit_salary_slip = function(doc, cdt, cdn) {\n\tcur_frm.cscript.display_activity_log(\"\");\n\n\tfrappe.confirm(__(\"Do you really want to Submit all Salary Slip from {0} to {1}\", [doc.start_date, doc.end_date]), function() {\n\t\t// clear all in locals\n\t\tif(locals[\"Salary Slip\"]) {\n\t\t\t$.each(locals[\"Salary Slip\"], function(name, d) {\n\t\t\t\tfrappe.model.remove_from_locals(\"Salary Slip\", name);\n\t\t\t});\n\t\t}\n\t\tcur_frm.cscript.display_activity_log(\"Submetendo Salarios... Aguarde.\");\n\t\tfrappe.call({\n\t\t\tmethod: \"angola_erp.angola_erpnext.validations.process_payroll.submit_salary_slips\",\n\t\t\targs: {\n\t\t\t\t\"doc\":cur_frm.doc,\t\t\t\t\n\t\t\t},\n\t\t\tcallback: function(r,rt) {\n\t\t\t\tif (r.message){\n\t\t\t\t\tcur_frm.cscript.display_activity_log(r.message);\n\t\t\t\t\tfrappe.model.set_value(cdt,cdn,'processa_inss',1);  \n\t\t\t\t}\n\t\t\t}\n\n\t\t});\t\n\n\n\t});\n}\n\ncur_frm.cscript.salary_review = function(doc,cdt,cdn){\n\t\n \tfrappe.route_options = {\n// \t\t\"start_date\": moment(cur_frm.doc.start_date,\"dd-MM-YYYY\"),\n// \t\t\"end_date\": moment(cur_frm.doc.end_date,\"dd-MM-YYYY\")\n\t\t\"date_range\": [cur_frm.doc.start_date,cur_frm.doc.end_date]\n\n\t};\n\tfrappe.set_route('query-report', 'Salary Review');\n\n}\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "SMS Center", 
  "modified": "2017-05-13 07:53:18.076941", 
  "name": "SMS Center-Client", 
  "script": "frappe.ui.form.on(\"SMS Center\", {\n\tonload:\tfunction(frm) {\n\t\t//Disable default send_sms button and enables ours\n\t\tcur_frm.toggle_enable(\"send_sms\",false)\n\t\tcur_frm.toggle_enable(\"enviar_mensagens\",true)\n\t\tcur_frm.set_df_property(\"enviar_mensagens\",\"hidden\",false)\n\t}\n});\n\n\ncur_frm.cscript.enviar_mensagens = function(doc,cdt,cdn){\n\tenviarsms = cur_frm.call({method:\"angola_erp.angola_erpnext.validations.sms_settings.send_sms\",args:{\"receiver_list\":cur_frm.doc.receiver_list, \"msg\": cur_frm.doc.message}})\n\t\n}", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "GL Entry", 
  "modified": "2017-05-17 15:43:45.715514", 
  "name": "GL Entry-Client", 
  "script": "\"formatter\":function (row, cell, value, columnDef, dataContext, default_formatter) {\n                    value = default_formatter(row, cell, value, columnDef, dataContext);\n            if (columnDef.id == \"Debit\") {\n                                   if(dataContext.Debit>1){\n                                    value = \"<span style='color:blue;font-weight:bold'>\" + value + \"</span>\";\n                                    }\n                        msgprint(dataContext.Debit)\n\n            }\n\n\n            if (dataContext.Debit) {\n            }\n\n            return value;\n        }", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Quotation", 
  "modified": "2017-06-20 09:25:47.580123", 
  "name": "Quotation-Client", 
  "script": "taxavenda= cur_frm.call({method:\"angola_erp.util.cambios.cambios\",args:{\"fonte\":\"BNA\"}})\nlista_retencoes = cur_frm.call({method:\"angola_erp.util.angola.get_lista_retencoes\",args:{}})\nlista_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_retencao\",args:{}})\nlista_impostos = cur_frm.call({method:\"angola_erp.util.angola.get_taxa_ipc\",args:{}})\n\nvar temretencao = false \nvar temimpostoconsumo = false \nvar retencaofonte =0\nvar retencaopercentagem =0\nvar totalpararetencao = 0\nvar totalgeralimpostoconsumo = 0\nvar totalgeralretencaofonte = 0\nvar totalbaseretencaofonte = 0\nvar retencaofonteDESC\nvar totalservicos_retencaofonte =0\nvar totaldespesas_noretencaofonte =0\n\nfrappe.ui.form.on(\"Quotation\", {\n\tonload:\tfunction(frm) {\n\t\tcur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t},\n\trefresh: function(frm) {\n\t\t//cur_frm.toggle_enable(\"contra_valor\",false)\n//\t\tcur_frm.toggle_enable(\"total_retencao_na_fonte\",false)\n\t\tcur_frm.toggle_enable(\"taxa_cambio\",false)\n\t}\t\n\n});\n  \nfrappe.ui.form.on(\"Quotation\",\"validate\", function (frm) {\n\t//alert (\"Validar\")\n\t//Taxa de Cambio\n\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\tcur_frm.doc.taxa_cambio_bna = taxavenda.responseJSON.message[1]\n\t}\t\t\n\t\t\n});\n\ncur_frm.cscript.custom_charge_type = function(doc,cdt,cd){\n\t\t\talert (\"custom Charge_type\")\n\t\t\tvar d = locals[cdt][cd]\t\n\t\t\tif (d.charge_type == 'On Net Total') {\t\t\t\n\t\t\t\tfrappe.model.set_value(cdt,cd,'rate', 6.5)\n\t\t\t\tfrappe.model.set_value(cdt,cd,'account_head','34130000-I Industrial - Retencao A Liquidar') \n\t\t\t\t\n\t\t\t}\n}\n\n\n\t\nfrappe.ui.form.on(\"Quotation\",\"cambio_bna\", function(frm,cdt,cdn) {\n\tfrappe.call({\n\t\tasync: true,\n\t\tmethod: \"angola_erp.util.cambios.cambios\",\n\t\targs: {\n\t\t\t\"fonte\":\"BNA\"},\n\t\t\tcallback: function(r) {\n\t\t\t\ttaxavenda = r.message\n\t\t\t\tcur_frm.doc.taxa_cambio = taxavenda[1]\n\t\t\t\trefresh_field(\"taxa_cambio\")\n\t\t\t}\n\t\n\t});\n});\n\t\t\nfrappe.ui.form.on(\"Quotation\",\"customer\", function(doc,cdt,cdn) {\n\t\t//cur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t\t//cur_frm.toggle_enable(\"taxa_cambio\",false)\n\t\t//Taxa de Cambio\n\t\tif (taxavenda.responseJSON != undefined && cur_frm.doc.taxa_cambio == 0){\n\t\t\tcur_frm.doc.taxa_cambio = taxavenda.responseJSON.message[1]\n\t\t\tcur_frm.refresh_fields('taxa_cambio')\n\t\t}\t\t\n});\n\ncur_frm.add_fetch('item_code','standard_rate','rate')\n\nfrappe.ui.form.on(\"Quotation Item\",\"item_code\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\t\n\ttotalpararetencao = d.amount\n\n\tif (d.item_code){\n\t\tshow_alert(\"Total \" + d.amount,3)\t\n\t\tretencaofonte =0\n\t\tretencaopercentagem =0\n\t\tfrappe.model.with_doc(\"Item\", d.item_code, function() { \n\t\t\tvar dd = frappe.model.get_doc(\"Item\",d.item_code)\n\t//\t\talert (\"rotina \", d.retencao_na_fonte)\n\t\t\tif (dd.retencao_na_fonte == 1){\n\t//\t\tif (d.que_retencao !=\"\"){\n\t\t\t\tfor (x = 0; x < lista_retencoes.responseJSON.message.length; x++){\n\t\t\t\t\tif (lista_retencoes.responseJSON.message[x].descricao == dd.que_retencao) {\n\t\t\t\t\t\tretencaopercentagem = lista_retencoes.responseJSON.message[x].percentagem\t\t\t\n\t\t\t\t\t\tretencaofonteDESC = dd.que_retencao\n\t\t\t\t\t}\t\t\t\n\t\t\t\t}\t\n\t\t\t\t//Retencao from Taxe and Charges list\n\t\t\t\tretencaofonteDESC = lista_retencao.responseJSON.message[0].parent \n\t\t\t\t\n\t\t\t}\n\t\t\t//First load qtd will always be 1 \n\t\t\tif (d.amount ==0){\n\t\t\t\td.retencao_na_fonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (dd.standard_rate * retencaopercentagem) / 100\n\t\t\t\n\t\t\t}else{\n\t\t\t\td.retencao_na_fonte = (d.amount * retencaopercentagem) / 100\n\t\t\t\tretencaofonte = (d.amount * retencaopercentagem) / 100\n\t\t\t}\n\t\t\t\n\t\t\tif (retencaofonte != 0) {\n\t\t\t\tshow_alert(\"Retencao na fonte\",3)\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//doc.set_value(\"taxes_and_charges\",retencaofonteDESC )\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t\n\t\t\t\t}\t\n\t\t\t}\t\t\t\n\t\t\tif (dd.imposto_de_consumo == 1){\n\t\t\t\t//Busca o Imposto from Sales Taxes Charges (account 34210000)\t\t\t\n\t\t\t\tshow_alert(\"Imposto de Consumo\",3)\t\t\t\t\t\n\t\t\t\td.imposto_de_consumo = (d.amount * 10) / 100\n\t\t\t\ttotalgeralimpostoconsumo += d.imposto_de_consumo \n\t\t\t\t\n\t\t\t\tif (doc.fields_dict.taxes_and_charges.value == null || doc.fields_dict.taxes_and_charges.value == \"\"){\n\t\t\t\t\t//Add Imposto e Consumo \n\t\t\t\t\t\n\t\t\t\t\tdoc.set_value(\"taxes_and_charges\", lista_impostos.responseJSON.message[0].parent )\n\t\t\t\t\tcur_frm.refresh_fields()\n\t\t\t\t\t//cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname[cdn].charge_type.refresh()\n\t\t\t\t\t// Now adds the Amount of the TAX based on the total of all itens \n\t\t\t\t\t//if(this.cur_frm.fields_dict[\"taxes\"].grid.get_field('charge_type')){\n\t\t\t\t\t//\talert(this.cur_frm.fields_dict[\"taxes\"].grid.grid_rows_by_docname['charge_type']) //get_field('charge_type'))\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\t\n\t\t\t\t\t//var tbl1 = cur_frm.doc.taxes || [];\n\t\t\t\t\t//alert (\"item code \" + tbl1.charge_type)\t\t\t\t\t\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,\"tax_amount\",totalgeralimpostoconsumo)  \n\t\t\t\t\t//} \t\t\n\t\t\t\t\t//cur_frm.cscript.validate_taxes_and_charges(\"Sales Taxes and Charges\", \"INVTD000005\" );\n\t\t\t\t\t\n//\t\t\t\t}else if (doc.fields_dict.taxes_and_charges.field[\"account_head\"] ==\"34210000\"){\n//\t\t\t\t\talert(\"AQUI Tem que ver\")\t\n\t\t\t\t\t\n\t\t\t\t}else{\n\t\t\t\t\t//frappe.model.set_value(cdt,cdn,frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)\n\t\t\t\t\tvar me = this;\n\t\t\t\t\tvar tbl1 = this.cur_frm.doc[\"taxes\"];\n\t\t\t\t\t//alert(frappe.utils.filter_dict(cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}))\n\t\t\t\t\t//frappe.model.set_value(frappe.utils.filter_dict(this.cur_frm.fields_dict[\"taxes\"].grid.docfields, {\"fieldname\": \"tax_amount\"}),totalgeralimpostoconsumo)  \n\t\t\t\t}\n\t\t\t\n\t\t\t}\t\n\t\n\n\t\t\t});\t\n\t}\n});\n\ncur_frm.cscript.amount = function(doc,cdt,cdn){\n//frappe.ui.form.on(\"Sales Invoice Item\",\"amount\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\talert(\"Total \" + d.amount)\n\t\n}\n//);\n\n\n\nfrappe.ui.form.on(\"taxes\",\"charge_type\", function(doc,cdt,cdn) {\n\tvar d = locals[cdt][cdn]\n\talert(\"AQUII\")\n\t\n\t\n\t\n});\n\ncur_frm.cscript.tax_amount = function(doc,cdt,cdn) {\n\talert(\"tax Amount\")\n\t\n}\n\ncur_frm.cscript.charge_type = function(doc,cdt,cdn) {\n\talert(\"Charge\")\n\t\n}\n\n\n\nvar itens_ = function(frm,cdt,cdn){\n\tfrappe.model.with_doc(frm, cdt, function() { \n\t\tvar d = frappe.model.get_doc(frm,cdt)\n//\t\talert (\"rotina \", d.retencao_na_fonte)\n\t\tif (d.retencao_na_fonte == 1){\n\t\t\tretencaofonte = d.que_retencao\n\t\t\tshow_alert(\"tem retencao na fonte: \" + d.que_retencao,3)\t\n\n\t\t\t\n//\t\t\tfrappe.model.with_doc(\"Retencoes\", d.que_retencao, function() { \t\n//\t\t\t\tvar retencao = frappe.model.get_doc(\"Retencoes\", d.que_retencao)\n//\t\t\t\tretencaopercentagem = retencao.percentagem\n//\t\t\t\talert(\"Percentagem \" + totalpararetencao + \" \" + retencao.percentagem)\n//\t\t\t});\t\n\t\t\t\n\t\t}\n\n\t});\n}\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Payment Entry", 
  "modified": "2017-08-05 00:47:47.159247", 
  "name": "Payment Entry-Client", 
  "script": "//HELKyds\nfornecedor_retencao = 0\nfatura_total_retencao_na_fonte = 0\nconta =0\ncompany_costcenter = 0\nold_reference_name = 0\nif (cur_frm.doc.party){fornecedor_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_supplier_retencao\",args:{\"fornecedor\":cur_frm.doc.party,\"fornclien\":cur_frm.doc.party_type}})}\ncontab_conta_retencao = cur_frm.call({method:\"angola_erp.util.angola.get_contab_taxa_retencao\",args:{\"empresa\":cur_frm.doc.company}})\nvar  lista = []\n\nfrappe.ui.form.on('Payment Entry', {\n\tonload: function(frm) {\n\t\tif(frm.doc.__islocal) {\n\t\t\t//frappe.show_alert(frm.doc.paid_from,2)\n\t\t\tif (frm.doc.party_type == 'Supplier'){\n\t\t\t\n\t\t\t\n\t\t\t\t//fornecedor_retencao = frm.call({method:\"angola_erp.util.angola.get_supplier_retencao\",args:{\"fornecedor\":frm.doc.party}})\n\t\t\t}\n\t\t\t//frm.set_df_property(\"reference_no\",\"reqd\",true)\n\t\t\t//cur_frm.set_df_property(\"taxa_cambio\",\"hidden\",false)\n\t\t\t//cur_frm.get_field('reference_no').df.reqd = true \n\t\t\t//if (!frm.doc.paid_from) frm.set_value(\"paid_from_account_currency\", null);\n\t\t\t//if (!frm.doc.paid_to) frm.set_value(\"paid_to_account_currency\", null);\n\t\t}\n\t\tfatura_total_retencao_na_fonte = 0\n\t\tconta =0\n\t\tcompany_costcenter = 0\n\t\told_reference_name = 0\n\t\tvar  lista = []\n\n\n\t\t\n\t},\n\t\n\trefresh: function(frm) {\n\t\t//frappe.show_alert(fornecedor_retencao\n\t\tconsole.log('REFRESSSSSSSHH ', conta)\n\t\tconta += 1\n\t\tif (cur_frm.doc.payment_type == 'Pay'){\n\t\t\tcur_frm.get_field('reference_no').df.reqd = true \n\t\t\tcur_frm.get_field('mode_of_payment').df.reqd = true \n\t\t\tif (company_costcenter == 0){company_costcenter = frappe.get_doc(\":Company\", frm.doc.company).cost_center};\n\t\t\t\n\t\t\tif (frm.doc.paid_from_account_currency != null){\n\t\t\t\t\n\t\t\t\tif(frm.doc.references.length != 0){\n\t\t\t\t\t\n\t\t\t\t\t$.each(frm.doc.references || [], function(i, row) {\n\t\t\n\t\t\t\t\t\t//get Retencao\n\t\t\t\t\t\t//dddd = frappe.get_doc(cur_frm.doc.party_type.valueOf(),cur_frm.doc.party.valueOf())\n\t\t\t\t\t\t//frappe.show_alert(retencao_supplier.retencao_na_fonte,2)\n\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (lista.length !=0){\n\t\t\t\t\t\t\tif (lista.search(row.reference_name) == -1){\n\t\t\t\t\t\t\t\tlista += ',' + row.reference_name\t\n\t\t\t\t\t\t\t\tfaturas_(row.reference_doctype,row.reference_name)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tlista += ',' + row.reference_name\t\n\t\t\t\t\t\t\tfaturas_(row.reference_doctype,row.reference_name)\n\t\t\t\t\t\t\t//cur_frm.set_value(\"paid_amount\", 0)\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//ddd = frappe.get_doc(row.reference_doctype,row.reference_name)\n\t\t\t\t\t\t//console.log(ddd.total_retencao_na_fonte)\n\n\t\t\t\t\t\tif (fatura_total_retencao_na_fonte !=0){\n\t\t\t\t\t\t\t//uncheck allocate_payment_amount\n\t\t\t\t\t\t\t//if (retencao_supplier.retencao_na_fonte =='Retencao na fonte'){\n\t\t\t\t\t\t\tcur_frm.doc.allocate_payment_amount=0\n\t\t\t\t\t\t\t//cur_frm.set_value(\"allocate_payment_amount\", 0 )\n\t\t\t\t\t\t\tif(frm.doc.references.length > 1){\n\t\t\t\t\t\t\t\tcur_frm.set_value(\"paid_amount\", cur_frm.doc.paid_amount + flt(row.outstanding_amount) - flt(fatura_total_retencao_na_fonte) )\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tcur_frm.set_value(\"paid_amount\", flt(row.outstanding_amount) - flt(fatura_total_retencao_na_fonte) )\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t//cur_frm.set_df_property(\"reference_no\",\"reqd\",true)\n\t\t\t\t\t\t\t//cur_frm.get_field('reference_no').df.reqd = true \n\t\t\t\t\t\t\t//row.allocated_amount = 1111111 //row.outstanding_amount\n\t\t\t\t\t\t\t//cur_frm.doc.paid_amount = flt(row.outstanding_amount) - flt(ddd.total_retencao_na_fonte)\n\t\t\t\t\t\t\t//}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t})\t\n\t\t\n\t\t\t\t\tconsole.log(company_costcenter)\n\t\t\t\t\tconsole.log(contab_conta_retencao.responseJSON.message[0].name)\n\t\t\t\t\tif (frm.doc.deductions ==0){\n\t\t\t\t\t\tvar c = frm.add_child(\"deductions\");\n\t\t\t\t\t\tc.account = contab_conta_retencao.responseJSON.message[0].name ; //34130000-I Industrial - Retencao A Liquidar\n\t\t\t\t\t\tc.cost_center = company_costcenter\n\t\t\t\t\t\tc.amount = flt(-fatura_total_retencao_na_fonte)\n\t\t\t\t\t//cur_frm.doc.allocate_payment_amount=0\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\tif (fornecedor_retencao.readyState == 4 && fornecedor_retencao.responseText.length >2){\n\t\t\t\t\tconsole.log(fornecedor_retencao.responseJSON.message[0].retencao_na_fonte)\n\t\t\t\t\tconsole.log(frm.doctype)\n\t\t\t\t\tconsole.log(frm.docname)\n\t\t\t\t\tcur_frm.doc.reference_date = frappe.datetime.nowdate()\n\t\t\t\t}else{\t\n\t\t\t\t\tfrappe.show_alert(\"Este Fornecedor nao tem Retencao na Fonte!!!\")\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t},\n\t\n\tparty: function(frm,cdn,cdt){\n\t\tif (fornecedor_retencao == 0){\n\t\t\tfrappe.show_alert(\"Ainda nao fui buscar a ficha !!!\")\n\t\t\t\n\t\t}\n\t},\n\t\n\treference_no: function(frm,cdn,cdt) {\n\t\tif (cur_frm.doc.payment_type == 'Pay'){\n\t\t\tconsole.log('tenta')\n\t\t\tcur_frm.doc.references[0].allocated_amount = cur_frm.doc.references[0].outstanding_amount\n\t\t\tcur_frm.doc.reference_date = frappe.datetime.nowdate()\n\t\t\tfrm.events.set_total_allocated_amount(frm);\n\t\t\tfrm.events.set_difference_amount(frm);\n\t\t\tfrm.refresh_fields()\n\t\t}\n\t},\n\t\n\n\t//Need to check for Retencao na Fonte to Uncheck this\n\t\n\tvalidate: function(frm,cdn,cdt){\n\t\tif (cur_frm.doc.payment_type == 'Pay'){\n\t\t\tif (!cur_frm.doc.reference_no){\n\t\t\t\t\n\t\t\t\tfrappe.msgprint(__(\"Cheque/Reference No\"));\n\t\t\t\tcur_frm.doc.references[0].allocated_amount = cur_frm.doc.references[0].outstanding_amount\n\t\t\t\t//throw \"cannot create\";\n\t\t\t\tvalidate =false;\n\t\t\t}else{\n\t\t\t\tcur_frm.doc.references[0].allocated_amount = cur_frm.doc.references[0].outstanding_amount\n\t\t\t}\n\t\t}\n\t},\n\n});\n\n\nvar faturas_ = function(frm,cdt,cdn){\n\tfrappe.model.with_doc(frm, cdt, function() { \n\t\tvar d = frappe.model.get_doc(frm,cdt)\n\t\tconsole.log('Facturas_')\n\t\tfatura_total_retencao_na_fonte += d.total_retencao_na_fonte\n\t\tconsole.log(fatura_total_retencao_na_fonte)\n\t\t\n\t\t//cur_frm.set_value(\"allocate_payment_amount\", 0 )\n\t\t//cur_frm.set_value(\"reference_no\", 0 )\n\t\t\n\t\t//var company_costcenter = frappe.get_doc(\":Company\", frm.doc.company).cost_center;\n\t\t//console.log(contab_conta_retencao.responseJSON.message[0].name)\n\t\tif (cur_frm.doc.deductions ==0){\n\t\t\tvar c = cur_frm.add_child(\"deductions\");\n\t\t\tc.account = contab_conta_retencao.responseJSON.message[0].name ; //34130000-I Industrial - Retencao A Liquidar\n\t\t\tc.cost_center = company_costcenter\n\t\t\tc.amount = flt(-fatura_total_retencao_na_fonte)\n\t\t}else{\n\t\t\tcur_frm.doc.deductions[0].amount = flt(-fatura_total_retencao_na_fonte)\n\t\t//cur_frm.doc.allocate_payment_amount=0\n\t\t}\n\t\tcur_frm.events.set_difference_amount(cur_frm);\n\t\t//cur_frm.set_value(\"paid_amount\", flt(row.outstanding_amount) - flt(fatura_total_retencao_na_fonte) )\n\n\t\n\n\t});\n\n\n}", 
  "script_type": "Client"
 }
]